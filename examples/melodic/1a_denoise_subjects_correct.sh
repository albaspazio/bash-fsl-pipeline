#  rename filtered_func_data to filtered_func_data_original, denoise filtered_func_data_original calling the denoised image as filtered_func_data...do featregapply.


#!/bin/bash


GLOBAL_SCRIPT_DIR=/media/data/MRI/scripts
PROJ_DIR=/media/data/MRI/projects/CAB/FSL_RESTING_DYT		# change according to your project absolute path
export FSLDIR=/usr/local/fsl																						# change according to used PC
#===============================================
. $GLOBAL_SCRIPT_DIR/init_vars.sh $PROJ_DIR
#===============================================
SESS_ID=1
declare -a arr_subjects2denoise=(DYT_B_prsic_svetislav DYT_ST_sencic_milanka)
declare -a arr_ic2remove=("1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,22,23,25,26,27,28,29,30,31,33,34,35,36,37,38,39,41,42,43,44,45,46,47,48,49,50,51,52,53,54" "1,2,3,4,5,6,7,8,9,10,11,12,13,14,16,17,18,19,20,21,22,23,24,26,27,28,30,31,35,36,37,38,40,43,45,46,47,49,50")
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================
#================================================================================================================================================================


num_subj=${#arr_subjects2denoise[@]}
num_cmp=${#arr_ic2remove[@]}

if [  $num_subj -ne $num_cmp ]; then echo "ERROR!! $num_subj .. $num_cmp "; exit; fi

declare -i cnt=0
for SUBJ_NAME in ${arr_subjects2denoise[@]}
do
	echo "$SUBJ_NAME"
  . $GLOBAL_SCRIPT_DIR/subject_init_vars.sh

  mv $RS_DATA.ica/reg_standard $RS_DATA.ica/reg_standard_original
  mv $RS_DATA.ica/filtered_func_data.nii.gz $RS_DATA.ica/filtered_func_data_original.nii.gz

	$FSLDIR/bin/fsl_regfilt -i $RS_DATA.ica/filtered_func_data_original.nii.gz -o $RS_DATA.ica/filtered_func_data.nii.gz -d $RS_DATA.ica/filtered_func_data.ica/melodic_mix -f "${arr_ic2remove[cnt]}"

	$FSLDIR/bin/featregapply $RS_DATA.ica

  $FSLDIR/bin/fslroi $RS_DATA.ica/filtered_func_data.nii.gz $RS_DATA.ica/filtered_func_data_skip4vol.nii.gz 4 196
  $FSLDIR/bin/fslroi $RS_DATA.ica/reg_standard/filtered_func_data.nii.gz $RS_DATA.ica/reg_standard/filtered_func_data_skip4vol.nii.gz 4 196
	
	cnt=$cnt+1
done

wait
echo "======> finished denoising subjects"


# "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48"
